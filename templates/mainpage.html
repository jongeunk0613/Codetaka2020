{% extends 'base.html' %}

{% csrf_token %}

{% block title%}
   {% if sc %}
      {{className}} | {{sc.name}}
   {% else %}
      {{className}}
   {% endif %}
{% endblock %}

{% block content %}
   <div id="mainScreen">
      
      <div id="secDir">
         <p id="fileList">File List</p>
         <div id="upload">
             <label id="createFolder" onclick="addFolderText()"><i class="material-icons">create_new_folder</i></label>
             <form method="post" enctype="multipart/form-data">
                  {% csrf_token %}
                  <label id="uploadFileLabel" for="uploadFile"><i class="material-icons">file_upload</i></label>
                  <input id="uploadFile" type="file" name="content" onchange="this.form.submit()"> </input>
            </form>
         </div>
         
         <div id="dirTree">
            {% if sclist %}
               {% for SC in sclist %}
                  {% if SC == sc %}
                     <div class="sc">
                     <i class="fa fa-file-code-o fileIcon"></i><a href="{% url 'openSC' className SC.id %}" class="currentSC">{{SC.name}}</a><br>
                     </div>
                  {% else %}
                     <div class="sc">
                     <i class="fa fa-file-code-o fileIcon"></i><a href="{% url 'openSC' className SC.id %}" >{{SC.name}}</a><br>
                     </div>
                  {% endif%}
               {% endfor %}
               {% for folder in folderlist %}
                     <div class="folder">
                     <i class="fas fa-folder folderIcon"></i>{{folder.name}}
                     </div>
               {% endfor %}
            {% endif %}
         </div>
         
      </div>
      
      <div id="codeMenu">
         <label id="auto-focus" class="switch">
            <label id="auto-focus-label"> Auto Focus</label>
           <input id="auto-focus-value" type="checkbox">
           <span class="slider round"></span>
         </label>
         <div id="divider1" class="vl"></div>
         <button id="menuBtnCreateComment"><i class = "fas fa-comment-alt"></i></button>
         <div id="divider2" class="vl"></div>
         <label id="menuBtnSpeaker">
            <input id="speaker" type="checkbox">
            <label id="speakerIcon" class="fas fa-microphone-alt"></label>
         </label>
         <div id="divider3" class="vl"></div>
         <label id="menuBtnPlay">
            <input id="play" type="checkbox">
            <label id="playIcon" class="fa fa-play-circle"></label>
         </label>
         <div id="divider4" class="vl"></div>
         <label id="menuBtnConnectedUsers">
            <input id="users" type="checkbox">
            <label id="usersIcon" class="fa fa-users"></label>
         </label>
         <div id="connectedUsersList">
         </div>
      </div>
      <div id="secCode">
         <div id="showContent">
            <div id="showLineNum" unselectable="on">
               <p unselectable="on" >
                  {% for i in range %}
                     {{i}}<br>
                  {% endfor %}
               </p>
            </div>
            <p id="code"></p>
         </div>
      </div>

      <div id="secChat">
         
         <!--X <input id="X" disabled><br>
         Y <input id="Y" disabled><br>
         X <input id="A" disabled><br>
         Y <input id="B" disabled><br>
         P <input id="P" disabled>
         <textarea id="try" style="width: 100%; height: 80%;"></textarea>-->
         <div id="chatLog" class="mesgs">
            <div id="chatHistory" class="msg_history">
            </div>
         </div><br>
         <div id="secMention">
         </div>
         <div id="chatBottom">
            <textarea id="chatInput"></textarea>
            <input id="chatSubmit" type="button" value="Send"></input>
         </div>
      </div>
   </div>

<script>
   var x = 0;
   var y = 0;
   var creatingComment = false;
   var creatingMention = false;
   var playComments = false;
   var comments;
   var currentComment = 0;
   var maxComment = 0;
   var lastMentionId = 0;
   var id = {{nextId}};
   var scId = {{sc.id}};
   var scName;
   var seltxt = window.getSelection();
   var mseltxt = "", manchorNodeID="", mfocusNodeID="";
   var {anchorNode, anchorOffset, focusNode, focusOffset} = window.getSelection();
   var target;
   var classname = "{{className}}";
   var classUsername = "{{classUsername}}";
   var userid = "{{user.id}}";
   var username = "{{user.username}}";
   var speakerStatus = false;
   //var scrollPos = 0;
   var htmlEntities = [
      [/&amp;/g, "&"],
      [/&lt;/g, "<"],
      [/&gt;/g, ">"],
      [/&quot;/g, "\""],
      [/&#x27;/g, "\'"],
   ];
   
   window.onload = prepare;
   
   function prepare() {
      saveUser();
      highlightSC();
      loadComments();
      loadMessages();
   }

   // GET ELEMENT WINDOW POSITION WHEN MOUSEDOWN
   document.getElementById("code").addEventListener('mousedown', function(e){
      x = e.target.closest('.line').offsetLeft + e.target.closest('.line').offsetWidth;
      y = e.target.offsetTop;
      
      //X.value = x;
      //Y.value = y;
   });

   // CREATE MENTION WHEN MOUSE UP + SAVE SOME INFO
   document.getElementById("code").addEventListener('mouseup', function(e){
      if (window.getSelection().toString().length > 0 && e.target.closest("#code").id == "code" && (e.target.className == "mentionCancelBtn") == false){
         seltxt = window.getSelection();
         anchorNode = seltxt.anchorNode;
         anchorOffset = anchorNode.parentNode.getAttribute('data-startIndex');
         focusNode = seltxt.focusNode;
         focusOffset = seltxt.focusNode.data.length + Number(focusNode.parentNode.getAttribute('data-startIndex'));
         target = e.target;
         
         var anchorNumber = Number(anchorNode.parentNode.id.substring(2));
         var focusNumber = Number(focusNode.parentNode.id.substring(2));
         var temp;
         if (focusNumber < anchorNumber){
            temp = anchorNode;
            anchorNode = focusNode;
            focusNode = temp;
         }
         window.getSelection().removeAllRanges();
         window.getSelection().setBaseAndExtent(anchorNode, 0, focusNode, focusNode.data.length);
         
         createMention();
         
         //alert("ANCHOR: " + anchorOffset + "\n" + "FOCUS: " + focusNode.parentNode.getAttribute('data-startIndex') + "+" + seltxt.focusNode.data.length + "=" + focusOffset);
      }
   });

   // CHANGE OR REQUEST SPEAKER
   document.getElementById("speaker").addEventListener('click', function(e){
      if (speakerStatus == false){
         if (document.getElementById("speaker").checked == true){
            document.getElementById("speaker").checked = false;
            scSocket.send(JSON.stringify({
               'todoType': "speakerRequest",
               'fromU': username,
            }));
            showNotification("Speaker request sent to the current speaker.", "warnings");
         }
      }
   });

   // WHEN SCROLLED
   window.addEventListener('scroll', function(e){
      if (document.getElementById("speaker").checked == true){
         scSocket.send(JSON.stringify({
            'todoType': "autofocus",
            'scrollPos': window.scrollY,
         }));
      }
   });

   // SELECTION BY TOKEN
   document.onselectionchange = function() {
      let {anchorNode, anchorOffset, focusNode, focusOffset} = document.getSelection();
      if (document.getElementById("speaker").checked == true){
         scSocket.send(JSON.stringify({
            'todoType': "autofocusSelection",
            'anchorNodeID': anchorNode.parentNode.id,
            'focusNodeID': focusNode.parentNode.id,
         }));
      }
   }

   // SEND MESSAGE OR MENTION
   document.getElementById("chatSubmit").addEventListener('click', function(e){
      if (creatingMention == true){
         saveMention(mseltxt, manchorNodeID, anchorOffset, mfocusNodeID, focusOffset);
         //FIX ANCHORNODE AND FOCUSNODE
      } else {
         sendMessage();
      }
   });

   // PLAY COMMENTS
   document.getElementById("play").addEventListener('click', function(e){
      if (playComments == false){
         playComments = true;
         currentComment = 0;
         maxComment = 0;
         comments = [];
         
         $.ajax({
            url: "{% url 'getCommentIDs' %}",
            type: "GET",
            data:{
               scId: scId,
            },
            success: function (response){
               //alert("SUCCESS\n" + response);
               comments = JSON.parse(response);
               maxComment = comments.length;
               
               window.scrollTo(0, comments[currentComment]["fields"].posY - 100);
               var start = document.getElementById(comments[currentComment]["fields"].anchorNodeID);
               var end = document.getElementById(comments[currentComment]["fields"].focusNodeID);
               window.getSelection().setBaseAndExtent(start, 0, end, 1);
               document.designMode = "on";
               document.execCommand("HiliteColor", false, "#d5f3f7");
               document.designMode = "off";
               window.getSelection().removeAllRanges();
               
               document.getElementById(`comment${comments[currentComment]["pk"]}`).click();
            },
            error: function (response){
               alert("ERROR\n" + response);
            }

         });
      }else
         playComments = false;
         document.designMode = "on";
         document.getElementById(`comment${comments[currentComment]["pk"]}`).click();
         var start = document.getElementById(comments[currentComment]["fields"].anchorNodeID);
         var end = document.getElementById(comments[currentComment]["fields"].focusNodeID);
         window.getSelection().setBaseAndExtent(start, 0, end, 1);
         document.execCommand("HiliteColor", false, "#fffead");
         document.designMode = "off";
         window.getSelection().removeAllRanges();
   });
   
   // LISTEN TO KEYSTROKE TO PLAY NEXT OR PREVIOUS COMMENT
   document.onkeydown = function(){
      if (playComments == true){
         switch (window.event.keyCode){
            case 37:
               var start = document.getElementById(comments[currentComment]["fields"].anchorNodeID);
               var end = document.getElementById(comments[currentComment]["fields"].focusNodeID);
               window.getSelection().setBaseAndExtent(start, 0, end, 1);
               document.designMode = "on";
               document.execCommand("HiliteColor", false, "#fffead");
               window.getSelection().removeAllRanges();
               document.getElementById(`comment${comments[currentComment]["pk"]}`).click();
               currentComment -= 1;
               if (currentComment == -1)
                  currentComment = maxComment-1;
               document.getElementById(`comment${comments[currentComment]["pk"]}`).click();
               var start = document.getElementById(comments[currentComment]["fields"].anchorNodeID);
               var end = document.getElementById(comments[currentComment]["fields"].focusNodeID);
               window.getSelection().setBaseAndExtent(start, 0, end, 1);
               document.execCommand("HiliteColor", false, "#d5f3f7");
               document.designMode = "off";
               window.getSelection().removeAllRanges();
               window.scrollTo(0, comments[currentComment]["fields"].posY - 100);
               break;
            case 39:
               var start = document.getElementById(comments[currentComment]["fields"].anchorNodeID);
               var end = document.getElementById(comments[currentComment]["fields"].focusNodeID);
               window.getSelection().setBaseAndExtent(start, 0, end, 1);
               document.designMode = "on";
               document.execCommand("HiliteColor", false, "#fffead");
               window.getSelection().removeAllRanges();
               document.getElementById(`comment${comments[currentComment]["pk"]}`).click();
               currentComment += 1;
               if (currentComment == maxComment)
                  currentComment = 0;
               document.getElementById(`comment${comments[currentComment]["pk"]}`).click();
               var start = document.getElementById(comments[currentComment]["fields"].anchorNodeID);
               var end = document.getElementById(comments[currentComment]["fields"].focusNodeID);
               window.getSelection().setBaseAndExtent(start, 0, end, 1);
               document.execCommand("HiliteColor", false, "#d5f3f7");
               document.designMode = "off";
               window.getSelection().removeAllRanges();
               window.scrollTo(0, comments[currentComment]["fields"].posY - 100);
               break;
         }
      }
   };

   // OPEN CONNECTED USER LIST
   document.getElementById("menuBtnConnectedUsers").addEventListener('click', function(e){
      if ($("#connectedUsersList").hasClass("open") == true){
         $("#connectedUsersList").removeClass("open");
         $("#connectedUsersList").css("visibility", "hidden");
      } else {
         $("#connectedUsersList").addClass("open");
         $("#connectedUsersList").css("visibility", "visible");
      }
   });

   // CREATE COMMENT
   document.getElementById("menuBtnCreateComment").addEventListener('click', function(e){
      
      if (seltxt.toString().length > 0 && target.closest("#code").id == "code"){
         
         if (creatingComment == false){
            
            var anchorNumber = Number(anchorNode.parentNode.id.substring(2));
            var focusNumber = Number(focusNode.parentNode.id.substring(2));
            
            var newComment = Object.create(Comment);
            newComment.id = id;
            id = id;
            newComment.seltxt = seltxt.toString();
            newComment.anchorNodeID = anchorNode.parentNode.id;
            newComment.anchorOffset = anchorOffset;
            newComment.focusNodeID = focusNode.parentNode.id;
            newComment.focusOffset = focusOffset;
            newComment.posX = x;
            newComment.posY = y;
            
            //X.value = newComment.anchorNodeID;
            //Y.value = newComment.focusNodeID;
            
            var newCommentIcon = newComment.createComment();
            document.getElementById("code").prepend(newCommentIcon);
            $(`#${newCommentIcon.id}`).css({"position": "absolute", "left":`${newComment.posX}px`, "top": `${newComment.posY}px` });
            $(`#${newCommentIcon.id}`).addClass("open");
            $(`#${newCommentIcon.id}Form`).css("visibility","visible");
            
            var start = document.getElementById(newComment.anchorNodeID);
            var end = document.getElementById(newComment.focusNodeID);
            window.getSelection().setBaseAndExtent(start, 0, end, 1);
            document.designMode = "on";
            document.execCommand("HiliteColor", false, "#fffead");
            document.designMode = "off";
            window.getSelection().removeAllRanges();
            
            creatingComment = true;
         } else {
            showNotification("There is a comment that is unfinished creating.", "warnings");
         }
      } else if (creatingMention == true){
         var mention = document.getElementById(`mention${lastMentionId}`);
         creatingMention = false;
         
         var newComment = Object.create(Comment);
         newComment.id = id;
         id = id;
         newComment.seltxt = mention.getAttribute("data-seltxt");
         newComment.anchorNodeID = mention.getAttribute("data-anchorNodeID");
         newComment.anchorOffset = mention.getAttribute("data-anchorOffset");
         newComment.focusNodeID = mention.getAttribute("data-focusNodeID");
         newComment.focusOffset = mention.getAttribute("data-focusOffset");
         newComment.posX = mention.getAttribute("data-posX");
         newComment.posY = mention.getAttribute("data-posY");
         
         var newCommentIcon = newComment.createComment();
         document.getElementById("code").prepend(newCommentIcon);
         $(`#${newCommentIcon.id}`).css({"position": "absolute", "left":`${newComment.posX}px`, "top": `${newComment.posY}px` });
         $(`#${newCommentIcon.id}`).addClass("open");
         $(`#${newCommentIcon.id}Form`).css("visibility","visible");
         
         var start = document.getElementById(newComment.anchorNodeID);
         var end = document.getElementById(newComment.focusNodeID);
         window.getSelection().setBaseAndExtent(start, 0, end, 1);
         document.designMode = "on";
         document.execCommand("HiliteColor", false, "#fffead");
         document.designMode = "off";
         window.getSelection().removeAllRanges();
         
         creatingComment = true;
         
         mention.remove();
      }
      else {
         showNotification("Select text to comment.", "warnings");
      }
   });

   /*document.onselectionchange = function() {
      let {anchorNode, anchorOffset, focusNode, focusOffset} = document.getSelection();
      X.value = `${anchorNode.parentNode.id}:${anchorOffset}`;
      Y.value = `${focusNode.parentNode.id}:${focusOffset}`;
      A.value = `${anchorNode.parentNode.id}:${0}`;
      B.value = `${focusNode.parentNode.id}:${focusNode.data.length}`;
   }*/

   // CHANNELS WEBSOCKET
   const scSocket = new WebSocket('ws://' + window.location.host + "/ws/sourcecode/" + "{{sc.id}}" + '/');
   
   // SAVE CONNECTED USER IN DB
   function saveUser() {
      $.ajax({
         url: "{% url 'userConnected' %}",
         type: "GET",
         data:{
            scId: scId,
         },
         success: function (response){
            //alert("SUCCESS\n" + response);
            
            loadConnectedUsers();
         },
         error: function (response){
            alert("ERROR\n" + response);
         }
      });
   }

   // SAVE DISCONNECTED USER IN DB
   window.addEventListener('beforeunload', function(e){
      e.preventDefault();
      $.ajax({
         url: "{% url 'userDisconnected' %}",
         type: "GET",
         data:{
            scId: scId,
         },
         success: function (response){
            //alert("SUCCESS\n" + response);
         },
         error: function (response){
            alert("DISCONNECT ERROR\n" + response);
         }
      });
   });

   scSocket.onclose = function(e){
   };
   
   // RECEIVE FROM WEBSOCKET
   scSocket.onmessage = function(e){
      var data = JSON.parse(e.data);
      var todoType = data['todoType'];
      
      if (todoType == "commentCreated"){
         var cid = data['cId'];
         var seltxt = data['seltxt'];
         var anchorNodeID = data['anchorNodeID'];
         var anchorOffset = data['anchorOffset'];
         var focusNodeID = data['focusNodeID'];
         var focusOffset = data['focusOffset'];
         var posx = data['posx'];
         var posy = data['posy'];
         var text = data['text'];
         
         var newComment = Object.create(Comment);
         newComment.id = cid;
         newComment.seltxt = seltxt;
         newComment.anchorNodeID = anchorNodeID;
         newComment.anchorOffset = anchorOffset;
         newComment.focusNodeID = focusNodeID;
         newComment.focusOffset = focusOffset;
         newComment.posX = posx;
         newComment.posY = posy;
         newComment.text = text;
         
         var newCommentIcon = newComment.fixedComment();
         document.getElementById("code").prepend(newCommentIcon);
         $(`#${newCommentIcon.id}`).css({"position": "absolute", "left":`${newComment.posX}px`, "top": `${newComment.posY}px` });
         
         var start = document.getElementById(newComment.anchorNodeID);
         var end = document.getElementById(newComment.focusNodeID);
         window.getSelection().setBaseAndExtent(start, 0, end, 1);
         document.designMode = "on";
         document.execCommand("HiliteColor", false, "#fffead");
         document.designMode = "off";
         window.getSelection().removeAllRanges();
         
      } else if (todoType == "commentEdited"){
         var cid = data['cId'];
         var seltxt = data['seltxt'];
         var anchorNodeID = data['anchorNodeID'];
         var anchorOffset = data['anchorOffset'];
         var focusNodeID = data['focusNodeID'];
         var focusOffset = data['focusOffset'];
         var posx = data['posx'];
         var posy = data['posy'];
         var text = data['text'];
         
         document.getElementById(`comment${cid}`).remove();
         
         var newComment = Object.create(Comment);
         newComment.id = cid;
         newComment.seltxt = seltxt;
         newComment.anchorNodeID = anchorNodeID;
         newComment.anchorOffset = anchorOffset;
         newComment.focusNodeID = focusNodeID;
         newComment.focusOffset = focusOffset;
         newComment.posX = posx;
         newComment.posY = posy;
         newComment.text = text;
         
         var newCommentIcon = newComment.fixedComment();
         document.getElementById("code").prepend(newCommentIcon);
         $(`#${newCommentIcon.id}`).css({"position": "absolute", "left":`${newComment.posX}px`, "top": `${newComment.posY}px` });
      } else if (todoType == "commentDeleted"){
         var cid = data['cId'];
         var anchorNodeID = data['anchorNodeID'];
         var focusNodeID = data['focusNodeID'];
         cancelComment(cid, anchorNodeID, focusNodeID);
      } else if (todoType == "messageSent"){
         var muserid = data['userid'];
         var mcontent = data['content'];
         var mtimestamp = data['timestamp'];
         
         if (muserid == userid){
            var newMessage = Object.create(Message);
            newMessage.userid = muserid;
            newMessage.content = mcontent;
            newMessage.timestamp = mtimestamp.substring(3, mtimestamp.length-3);
            newMessage.createOutgoingMessage();
         } else {
            var newMessage = Object.create(Message);
            newMessage.userid = muserid;
            newMessage.content = mcontent;
            newMessage.timestamp = mtimestamp.substring(3, mtimestamp.length-3);
            newMessage.createIncomingMessage();
         }
      } else if (todoType == "autofocus"){
         if (document.getElementById("auto-focus-value").checked == true){
            window.scrollTo(0, Number(data['scrollPos']));
         }
      } else if (todoType == "speakerRequest"){
         var fromU = data['fromU'];
         var toU = data['toU'];
         
         if (toU == username){
            choose(`${fromU} has sent a speaker request. \nDo you accept?`, function() {acceptSpeakerRequest(fromU, toU);}, function() {declineSpeakerRequest(fromU, toU);});
         }
      } else if (todoType == "speakerRequestResponse"){
         var ownerU = data['ownerU'];
         var requestU = data['requestU'];
         var requestResponse = data['response'];
         
         if (requestU == username){
            if (requestResponse == true){
               document.getElementById("speaker").checked = true;
               showNotification(`Request accepted.\nYou are the current speaker.`, "warnings");
               document.getElementById("auto-focus-value").checked = false;
            } else {
               showNotification(`${ownerU} has declined your speaker request.`, "warnings");
            }
         }
      } else if (todoType == "autofocusSelection"){
         var anchorNodeID = data['anchorNodeID'];
         var focusNodeID = data['focusNodeID'];
         
         if (document.getElementById("auto-focus-value").checked == true){
            var start = document.getElementById(anchorNodeID);
            var end = document.getElementById(focusNodeID);
            window.getSelection().removeAllRanges();
            window.getSelection().setBaseAndExtent(start, 0, end, 1);
         }
      } else if (todoType == "mentionCreated"){
         var muserid = data['userid'];
         var musername = data['username'];
         var mid = data['mId'];
         var mseltxt = data['seltxt'];
         var manchorNodeID = data['anchorNodeID'];
         var manchorOffset = data['anchorOffset'];
         var mfocusNodeID = data['focusNodeID'];
         var mfocusOffset = data['focusOffset'];
         var mtext = data['text'];
         var mtimestamp = data['timestamp'].substring(3, data['timestamp'].length-3);
               
         if (username == musername){
            var newMention = Object.create(Mention);
            newMention.id = mid;
            newMention.seltxt = mseltxt;
            newMention.text = mtext;
            newMention.timestamp = mtimestamp;
            newMention.anchorNodeID = manchorNodeID;
            newMention.anchorOffset = manchorOffset;
            newMention.focusNodeID = mfocusNodeID;
            newMention.focusOffset = mfocusOffset;
            newMention.outgoingMention();
         } else {
            var newMention = Object.create(Mention);
            newMention.id = mid;
            newMention.seltxt = mseltxt;
            newMention.text = mtext;
            newMention.timestamp = mtimestamp;
            newMention.anchorNodeID = manchorNodeID;
            newMention.anchorOffset = manchorOffset;
            newMention.focusNodeID = mfocusNodeID;
            newMention.focusOffset = mfocusOffset;
            newMention.incomingMention();
            
         }
      }
   }

   // HIGHLIGHT SC AND DISPLAY
   function highlightSC() {
      var content = "{{js_fcontent}}";
      content = content.substring(6, content.length-6);
      
      //SYNTAX HIGHLIGHTING
      var highlighted = hljs.highlightAuto(content).value;
      for (var i = 0; i < htmlEntities.length; i++){
         highlighted = highlighted.replace(htmlEntities[i][0], htmlEntities[i][1]);
      }
      
      // ADD NODES BY TOKEN
      var bylines = highlighted.split("\n");
      for (var i = 0; i < bylines.length; i++){
         var oneline = bylines[i];
         var letter = 0;
         var length = oneline.length;
         var startCounting = false;
         var count = 1;
         while(letter < length){
            if (letter == length -1)
               break;
            switch(oneline[letter]){
               case " ":
                  if (startCounting == true){
                     //alert("COUNT: " + (count+1) + "| whitespace");
                     count += 1;
                  }
                  letter += 1;
                  break;
               case "<":
                  if (oneline.substring(letter, letter+5) == "<span"){
                     letter += 1;
                     while (oneline[letter] != ">"){
                        letter += 1;
                     }
                  } else if (oneline.substring(letter,letter+7) == "</span>"){
                     letter += "</span>".length-1;
                  } else {
                     var taglen = `<span data-startIndex='${count}' data-lineNumber='${i+1}'>`.length;
                     oneline = oneline.substring(0, letter) + `<span data-startIndex='${count}' data-lineNumber='${i+1}'>` + oneline.substring(letter);
                     //alert("OPENING |" + oneline);
                     letter += taglen;
                     length += taglen;
                     //alert("COUNT: " + (count+1) + "|" + oneline[letter]);
                     count += 1;
                     oneline = oneline.substring(0, letter) + "</span>" + oneline.substring(letter);
                     //alert("CLOSING |" + oneline);
                     taglen = "</span>".length;
                     letter += taglen;
                     length += taglen;
                  }
                  letter += 1;
                  break;
               default:
                  if (startCounting == false){
                     startCounting = true;
                  }
                  var taglen = `<span data-startIndex='${count}' data-lineNumber='${i+1}'>`.length;
                  oneline = oneline.substring(0, letter) + `<span data-startIndex='${count}' data-lineNumber='${i+1}'>` + oneline.substring(letter);
                  //alert("OPENING " + oneline);
                  letter += taglen;
                  length += taglen;
                  while(oneline[letter] != " "){
                     if (letter == length - 1){
                        break;
                     } else if (oneline.substring(letter+1, letter+8) == "</span>"){
                        //alert("COUNT: " + (count+1) + "|" + oneline[letter]);
                        letter += 1;
                        count += 1;
                        break;
                     } else if (oneline.substring(letter+1, letter+6) == "<span"){
                        //alert("COUNT: " + (count+1) + "|" + oneline[letter]);
                        letter += 1;
                        count += 1;
                        break;
                     }
                     //alert("COUNT: " + (count+1) + "|" + oneline[letter]);
                     letter += 1;
                     count += 1;
                  }
                  if (letter == length - 1){
                     oneline = oneline + "</span>";
                     //alert("LAST");
                  } else {
                     oneline = oneline.substring(0, letter) + "</span>" + oneline.substring(letter);
                  }
                  //alert("CLOSING " + oneline);
                  taglen = "</span>".length;
                  letter += taglen;
                  length += taglen;
            }
         }
         bylines[i] = oneline;
      }
      var line = bylines.join("\n");
      
      // ADD NODES BY LINE
      bylines = line.split("\n");
      for (var i = 0; i < bylines.length; i++){
         var oneline = bylines[i];
         bylines[i] = `<span class='line' data-lineNumber='${i+1}'>` + oneline + "</span>";
      }
      line = bylines.join("\n");
      document.getElementById("code").innerHTML = line;
      
      // ADD IDS TO EACH NODE
      var grandels = $("#code").find("span");
      var n = 1;
      for (var i = 0; i < grandels.length; i++){
         grandels[i].id = `el${n}`;
         n += 1;
      }
      
      //document.getElementById("try").innerHTML = document.getElementById("code").innerHTML;
   }

   // LOAD COMMENTS
   function loadComments() {
      if (id != -1){
         var commentlist = {{commentlist|safe}};
         for (var i = 0; i < commentlist.length; i++){
            var newComment = Object.create(Comment);
            newComment.id = commentlist[i]["pk"];
            newComment.seltxt = commentlist[i]["fields"].seltxt;
            newComment.anchorNodeID = commentlist[i]["fields"].anchorNodeID;
            newComment.anchorOffset = commentlist[i]["fields"].anchorOffset;
            newComment.focusNodeID = commentlist[i]["fields"].focusNodeID;
            newComment.focusOffset = commentlist[i]["fields"].focusOffset;
            newComment.posX = commentlist[i]["fields"].posX;
            newComment.posY = commentlist[i]["fields"].posY;
            newComment.text = commentlist[i]["fields"].text;
            
            var newCommentIcon = newComment.fixedComment();
            
            document.getElementById("code").prepend(newCommentIcon);
            $(`#${newCommentIcon.id}`).css({"position": "absolute", "left":`${newComment.posX}px`, "top": `${newComment.posY}px` });
            
            var start = document.getElementById(commentlist[i]["fields"].anchorNodeID);
            var end = document.getElementById(commentlist[i]["fields"].focusNodeID);
            window.getSelection().setBaseAndExtent(start, 0, end, 1);
            document.designMode = "on";
            document.execCommand("HiliteColor", false, "#fffead");
            document.designMode = "off";
            window.getSelection().removeAllRanges();
         }
      }
   }

   //document.execCommand("RemoveFormat", false, null);

   // LOAD MESSAGES
   function loadMessages() {
      var messagelist = {{messagelist|safe}};
      var mentionlist = {{mentionlist|safe}};
      var messageCount = messagelist.length - 1;
      var mentionCount = mentionlist.length - 1;
      var lastDate = "";
      var nextDate = "";
      
      
      var todo = 0;
      if (messageCount >= 0 && mentionCount >= 0){
         todo = 1;
         lastDate = new Date((messagelist[messageCount]["fields"].timestamp).substring(5,7) + " " + (messagelist[messageCount]["fields"].timestamp).substring(8,10) + " " + (messagelist[messageCount]["fields"].timestamp).substring(0,4));
      } else if (messageCount > 0){
         todo = 2;
         lastDate = new Date((messagelist[messageCount]["fields"].timestamp).substring(5,7) + " " + (messagelist[messageCount]["fields"].timestamp).substring(8,10) + " " + (messagelist[messageCount]["fields"].timestamp).substring(0,4));
      } else {
         todo = 3;
         lastDate = new Date((mentionlist[mentionCount]["fields"].timestamp).substring(5,7) + " " + (mentionlist[mentionCount]["fields"].timestamp).substring(8,10) + " " + (mentionlist[mentionCount]["fields"].timestamp).substring(0,4));
      }
      
      while (messageCount >= 0 || mentionCount >= 0) {
         switch(todo){
            case 1:
               //message는 있는데 mention는 없는 경우 시간 비교 처리
               //CALCULATE WHICH ONE TODO
               if (messageCount >= 0 && mentionCount >= 0){
                  var messageTime = messagelist[messageCount]["fields"].timestamp;
                  var mentionTime = mentionlist[mentionCount]["fields"].timestamp;
                  
                  if (messageTime > mentionTime){
                     todo = 3;
                  } else {
                     todo = 2;
                  }
               } else if (messageCount >= 0){
                  todo = 2;
               } else {
                  todo = 3;
               }
               break;
            case 2:
               //MESSAGE
               var muserid = messagelist[messageCount]["fields"].user;
               var mcontent = messagelist[messageCount]["fields"].content;
               var mtimestamp = messagelist[messageCount]["fields"].timestamp;
               
               nextDate = new Date((messagelist[messageCount]["fields"].timestamp).substring(5,7) + " " + (messagelist[messageCount]["fields"].timestamp).substring(8,10) + " " + (messagelist[messageCount]["fields"].timestamp).substring(0,4));
               lastDate = insertDate(lastDate, nextDate, mtimestamp);
               
               if (muserid == userid){
                  var newMessage = Object.create(Message);
                  newMessage.userid = muserid;
                  newMessage.content = mcontent;
                  newMessage.timestamp = mtimestamp;
                  newMessage.createOutgoingMessage();
                  
               } else {
                  var newMessage = Object.create(Message);
                  newMessage.userid = muserid;
                  newMessage.content = mcontent;
                  newMessage.timestamp = mtimestamp;
                  newMessage.createIncomingMessage();
               }
               messageCount -= 1;
               todo = 1;
               break;
            case 3:
               //MENTION
               var muser = mentionlist[mentionCount]["fields"].user;
               var mid = mentionlist[mentionCount]["pk"];
               var mseltxt = mentionlist[mentionCount]["fields"].seltxt;
               var manchorNodeID = mentionlist[mentionCount]["fields"].anchorNodeID;
               var manchorOffset = mentionlist[mentionCount]["fields"].anchorOffset;
               var mfocusNodeID = mentionlist[mentionCount]["fields"].focusNodeID;
               var mfocusOffset = mentionlist[mentionCount]["fields"].focusOffset;
               var mtext = mentionlist[mentionCount]["fields"].text;
               var mtimestamp = mentionlist[mentionCount]["fields"].timestamp;
               
               nextDate = new Date((mentionlist[mentionCount]["fields"].timestamp).substring(5,7) + " " + (mentionlist[mentionCount]["fields"].timestamp).substring(8,10) + " " + (mentionlist[mentionCount]["fields"].timestamp).substring(0,4));
               lastDate = insertDate(lastDate, nextDate, mtimestamp);
               
               if (muser == userid){
                  var newMention = Object.create(Mention);
                  newMention.id = mid;
                  newMention.seltxt = mseltxt;
                  newMention.text = mtext;
                  newMention.timestamp = mtimestamp;
                  newMention.anchorNodeID = manchorNodeID;
                  newMention.anchorOffset = manchorOffset;
                  newMention.focusNodeID = mfocusNodeID;
                  newMention.focusOffset = mfocusOffset;
                  newMention.outgoingMention();
               } else {
                  var newMention = Object.create(Mention);
                  newMention.id = mid;
                  newMention.seltxt = mseltxt;
                  newMention.text = mtext;
                  newMention.timestamp = mtimestamp;
                  newMention.anchorNodeID = manchorNodeID;
                  newMention.anchorOffset = manchorOffset;
                  newMention.focusNodeID = mfocusNodeID;
                  newMention.focusOffset = mfocusOffset;
                  newMention.incomingMention();
               }
               mentionCount -= 1;
               todo = 1;
               break;
         }
      }
   }

   // INSERT DATE INTO CHAT
   function insertDate(lastDate, nextDate, mdate){
      //DATEEEEEEEE COMPARISON STRINGGG!!!!
      //HEREREEEEEE
      // HIIIII
      if (lastDate == nextDate){
         var dateDiv = document.createElement("div");
         dateDiv.className = "date";
         var date = document.createElement("p");
         date.innerHTML = mdate.substring(5,7) + " " + mdate.substring(8,10) + " " + mdate.substring(0,4);
         dateDiv.appendChild(date);
         document.getElementById("chatHistory").appendChild(dateDiv);
         lastDate = nextDate;
      }
      return lastDate;
   }

   // LOAD CONNECTED USERS
   function loadConnectedUsers() {
      getSpeakerUser();
      $.ajax({
         url: "{% url 'getConnectedUsers' %}",
         type: "GET",
         data:{
            scId: scId,
         },
         success: function (response){
            //alert("SUCCESS\n" + response);
            var users = JSON.parse(response);
            
            for (var i = 0; i < users.length; i++){
               var divUser = document.createElement("div");
               divUser.id = `user${users[i]["fields"].user}`;
               var userIcon = document.createElement("i");
               if (users[i]["fields"].userName == username && speakerStatus == true){
                  userIcon.className = "fas fa-user-check";
                  userIcon.setAttribute("style", "color: #1e68a8;");
               } else {
                  userIcon.className = "fas fa-user-alt";
               }
               divUser.appendChild(userIcon);
               var userName = document.createElement("p");
               userName.innerHTML = users[i]["fields"].userName;
               divUser.appendChild(userName);
               document.getElementById("connectedUsersList").appendChild(divUser);
            }
         },
         error: function (response){
            alert("ERROR\n" + response);
         }
      });
   }

   // GET THE SPEAKER USER
   function getSpeakerUser() {
      $.ajax({
         url: "{% url 'getSpeakerUser' %}",
         type: "GET",
         data:{
            scId: scId,
         },
         success: function (response){
            //alert("SUCCESS\n" + response);
            var users = JSON.parse(response);
            
            var speakerUserId = users[0]["fields"].user;
            if (userid == speakerUserId){
               speakerStatus = true;
            }
         },
         error: function (response){
            alert("ERROR\n" + response);
         }
      });
   }

   //COMMENT OBJECT
   const Comment = {
      id: 0,
      seltxt: '',
      anchorNodeID: 0,
      anchorOffset: 0,
      focusNodeID: 0,
      focusOffset: 0,
      posX: 0,
      posY: 0,
      text: '',
      createComment() {
         var id = this.id;
         var seltxt = this.seltxt;
         var anchorNodeID = this.anchorNodeID;
         var anchorOffset = this.anchorOffset;
         var focusNodeID = this.focusNodeID;
         var focusOffset = this.focusOffset;
         var posX = this.posX;
         var posY = this.posY;
         var text = this.text;
         var comment = this;
         var commentForm = document.createElement("div");
         commentForm.className = "commentForm";
         commentForm.id = `comment${this.id}Form`;
         /*var commentMinimizeBtn = document.createElement("button");
         commentMinimizeBtn.className = "commentMinimizeBtn";
         var minimizeIcon = document.createElement("i");
         minimizeIcon.className = "fas fa-window-minimize minimize";
         commentMinimizeBtn.appendChild(minimizeIcon);
         commentForm.appendChild(commentMinimizeBtn);*/
         var commentContent = document.createElement("textarea");
         commentContent.innerHTML = text;
         commentContent.className = "commentContent";
         commentContent.setAttribute("type", "text");
         commentContent.setAttribute("id", `comment${this.id}Content`);
         commentForm.appendChild(commentContent);
         var commentCancelBtn = document.createElement("input");
         commentCancelBtn.className = "commentCancelBtn";
         commentCancelBtn.setAttribute("id", `comment${this.id}CancelBtn`);
         commentCancelBtn.type = "button";
         commentCancelBtn.addEventListener('click', function(event) {
            event.preventDefault();
            cancelComment(id, anchorNodeID, focusNodeID);
         });
         commentCancelBtn.setAttribute("value", "Cancel");
         commentForm.appendChild(commentCancelBtn);
         var commentSaveBtn = document.createElement("input");
         commentSaveBtn.className = "commentSaveBtn";
         commentSaveBtn.setAttribute("id", `comment${this.id}SaveBtn`);
         commentSaveBtn.type = "button";
         commentSaveBtn.addEventListener('click', function(event) {
            event.preventDefault();
            saveComment(id, seltxt, anchorNodeID, anchorOffset, focusNodeID, focusOffset, posX, posY, text);
         });
         commentSaveBtn.setAttribute("value", "Save");
         commentForm.appendChild(commentSaveBtn);
         
         var icon = document.createElement("div");
         icon.className = "commentIcon";
         icon.id = `comment${this.id}`;
         icon.appendChild(commentForm);
         //icon.css({"position": "absolute", "left": `${this.posX}px`, "top": `${this.posY}px`});
         //CLICK TOGGLE - OPEN & CLOSE
         icon.addEventListener('click', function(e){
            if ($(`#${e.target.id}`).hasClass("commentIcon") == true){
               if ($(`#${e.target.id}`).hasClass("open")){
                  $(`#${e.target.id}`).removeClass("open");
                  $(`#${e.target.id}Form`).css("visibility","hidden");
               } else {
                  $(`#${e.target.id}`).addClass("open");
                  $(`#${e.target.id}Form`).css("visibility","visible");
               }
            }
         });
         
         return icon;
      },
      fixedComment() {
         var id = this.id;
         var seltxt = this.seltxt;
         var anchorNodeID = this.anchorNodeID;
         var anchorOffset = this.anchorOffset;
         var focusNodeID = this.focusNodeID;
         var focusOffset = this.focusOffset;
         var posX = this.posX;
         var posY = this.posY;
         var text = this.text;
         var comment = this;
         var commentForm = document.createElement("div");
         commentForm.className = "commentForm";
         commentForm.id = `comment${this.id}Form`;
         var commentContent = document.createElement("textarea");
         commentContent.readOnly = true;
         commentContent.innerHTML = text;
         commentContent.className = "commentContent";
         commentContent.setAttribute("type", "text");
         commentContent.setAttribute("id", `comment${this.id}Content`);
         commentForm.appendChild(commentContent);
         var commentDeleteBtn = document.createElement("input");
         commentDeleteBtn.className = "commentCancelBtn";
         commentDeleteBtn.setAttribute("id", `comment${this.id}DeleteBtn`);
         commentDeleteBtn.type = "button";
         commentDeleteBtn.addEventListener('click', function(event) {
            event.preventDefault();
            deleteComment(id, anchorNodeID, focusNodeID);
         });
         commentDeleteBtn.setAttribute("value", "Delete");
         commentForm.appendChild(commentDeleteBtn);
         var commentEditBtn = document.createElement("input");
         commentEditBtn.className = "commentSaveBtn";
         commentEditBtn.setAttribute("id", `comment${this.id}EditBtn`);
         commentEditBtn.type = "button";
         commentEditBtn.addEventListener('click', function(event) {
            event.preventDefault();
            commentContent.readOnly = false;
            commentDeleteBtn.remove();
            commentForm.appendChild(comment.createEditCancelBtn());
            commentEditBtn.remove();
            commentForm.appendChild(comment.createEditSaveBtn());
         });
         commentEditBtn.setAttribute("value", "Edit");
         commentForm.appendChild(commentEditBtn);
         
         var icon = document.createElement("div");
         icon.className = "commentIcon";
         icon.id = `comment${this.id}`;
         icon.appendChild(commentForm);
         //icon.css({"position": "absolute", "left": `${this.posX}px`, "top": `${this.posY}px`});
         //CLICK TOGGLE - OPEN & CLOSE
         icon.addEventListener('click', function(e){
            if ($(`#${e.target.id}`).hasClass("commentIcon") == true){
               if ($(`#${e.target.id}`).hasClass("open")){
                  $(`#${e.target.id}`).removeClass("open");
                  $(`#${e.target.id}Form`).css("visibility","hidden");
               } else {
                  $(`#${e.target.id}`).addClass("open");
                  $(`#${e.target.id}Form`).css("visibility","visible");
               }
            }
         });
         
         return icon;
      },
      createDeleteBtn() {
         var id = this.id;
         var anchorNodeID = this.anchorNodeID;
         var focusNodeID = this.focusNodeID;
         var commentDeleteBtn = document.createElement("input");
         commentDeleteBtn.className = "commentCancelBtn";
         commentDeleteBtn.setAttribute("id", `comment${id}DeleteBtn`);
         commentDeleteBtn.type = "button";
         commentDeleteBtn.addEventListener('click', function(event) {
            event.preventDefault();
            deleteComment(id, anchorNodeID, focusNodeID);
         });
         commentDeleteBtn.setAttribute("value", "Delete");
         
         return commentDeleteBtn;
      },
      createEditBtn(){
         var comment = this;
         var commentEditBtn = document.createElement("input");
         commentEditBtn.className = "commentSaveBtn";
         commentEditBtn.setAttribute("id", `comment${comment.id}EditBtn`);
         commentEditBtn.type = "button";
         commentEditBtn.addEventListener('click', function(event) {
            event.preventDefault();
            document.getElementById(`comment${comment.id}Content`).readOnly = false;
            document.getElementById(`comment${comment.id}DeleteBtn`).remove();
            document.getElementById(`comment${comment.id}Form`).appendChild(comment.createEditCancelBtn());
            commentEditBtn.remove();
            document.getElementById(`comment${comment.id}Form`).appendChild(comment.createEditSaveBtn());
         });
         commentEditBtn.setAttribute("value", "Edit");
         
         return commentEditBtn;
      },
      createEditCancelBtn() {
         var comment = this;
         var beforeEdit = $(`#comment${comment.id}Content`).val();
         var commentEditCancelBtn = document.createElement("input");
         commentEditCancelBtn.className = "commentCancelBtn";
         commentEditCancelBtn.setAttribute("id", `comment${comment.id}EditCancelBtn`);
         commentEditCancelBtn.type = "button";
         commentEditCancelBtn.addEventListener('click', function(event) {
            event.preventDefault();
            document.getElementById(`comment${comment.id}Content`).value = beforeEdit;
            commentEditCancelBtn.remove();
            document.getElementById(`comment${comment.id}Form`).appendChild(comment.createDeleteBtn());
            document.getElementById(`comment${comment.id}Content`).setAttribute("readonly", "true");
            document.getElementById(`comment${comment.id}EditSaveBtn`).remove();
            document.getElementById(`comment${comment.id}Form`).appendChild(comment.createEditBtn());
         });
         commentEditCancelBtn.setAttribute("value", "Cancel");
         
         return commentEditCancelBtn;
      },
      createEditSaveBtn(){
         var comment = this;
         var commentEditSaveBtn = document.createElement("input");
         commentEditSaveBtn.className = "commentSaveBtn";
         commentEditSaveBtn.setAttribute("id", `comment${comment.id}EditSaveBtn`);
         commentEditSaveBtn.type = "button";
         commentEditSaveBtn.addEventListener('click', function(event) {
            event.preventDefault();
            document.getElementById(`comment${comment.id}Content`).setAttribute("readonly", "true");
            var text = document.getElementById(`comment${comment.id}Content`).value;
            saveEditedComment(comment.id, text);
         });
         commentEditSaveBtn.setAttribute("value", "Save");
         
         return commentEditSaveBtn
      }
   }

   // CANCEL COMMENT
   function cancelComment(commentID, anchorNodeID, focusNodeID){
      creatingComment = false;
      document.getElementById(`comment${commentID}`).remove();
      var start = document.getElementById(anchorNodeID);
      var end = document.getElementById(focusNodeID);
      window.getSelection().setBaseAndExtent(start, 0, end, 1);
      document.designMode = "on";
      document.execCommand("RemoveFormat", false, null);
      document.designMode = "off";
      window.getSelection().removeAllRanges();
   }

   // DELETE COMMENT
   function deleteComment(commentID, anchorNodeID, focusNodeID){
      $.ajax(
      {
         url: "{% url 'deleteComment' %}",
         type: "GET",
         data:{
            cId: commentID,
         },
         success: function (response){
            //alert("SUCCESS\n" + response);
            if (response == "NO ACCESS"){
               showNotification("You can't delete a comment that someone else has created.", "warnings");
            } else {
               response = response.split(" ");
               scSocket.send(JSON.stringify({
                  'todoType': "commentDeleted",
                  'cId': commentID,
                  'anchorNodeID': response[1],
                  'focusNodeID': response[2],
               }));
               
               cancelComment(response[0], response[1], response[2]);
            }
         },
         error: function (response){
            //alert("ERROR!!\n" + response);
         }
      });
   }

   //SAVE COMMENT
   function saveComment(id, seltxt, anchorNodeID, anchorOffset, focusNodeID, focusOffset, posX, posY, text){
      $.ajax(
      {
         url: "{% url 'getLatestCommentId' %}",
         type: "GET",
         success: function (response){
            
            $.ajax(
            {
               url: "{% url 'saveComment' %}",
               type: "GET",
               data:{
                   scId: {{sc.id}},
                   id: Number(response),
                   seltxt: seltxt,
                   anchorNodeID: anchorNodeID,
                   anchorOffset: anchorOffset,
                   focusNodeID: focusNodeID,
                   focusOffset: focusOffset,
                   posX: posX,
                   posY: posY,
                   text: $(`#comment${id}Content`).val(),
               },
               success: function (response){
                  document.getElementById(`comment${id}`).remove();
                  creatingComment = false;
                  //alert("SUCCESS\n" + response);
                  
                  scSocket.send(JSON.stringify({
                     'todoType': "commentCreated",
                     'cId': response,
                  }));
               },
               error: function (response){
                  //alert("ERROR!!\n" + response);
               }
            });
         },
         error: function (response){
            //alert("ERROR!!\n" + response);
         }
      });
   }

   // SAVE EDITED COMMENT
   function saveEditedComment(id, text){
      $.ajax(
      {
         url: "{% url 'saveEditedComment' %}",
         type: "GET",
         data:{
            cId: id,
            text: text,
         },
         success: function (response){
            //alert("SUCCESS\n" + response);
            
            scSocket.send(JSON.stringify({
               'todoType': "commentEdited",
               'cId': response,
            }));
         },
         error: function (response){
            //alert("ERROR!!\n" + response);
         }
      });
   }

   // MESSAGE OBJECT
   const Message = {
      userid: 0,
      content: "",
      timestamp: "",
      createOutgoingMessage() {
         var userid = this.userid;
         var mcontent = this.content;
         var timestamp = this.timestamp;
         var year = timestamp.substring(0,4);
         var month = timestamp.substring(5,7);
         var day = timestamp.substring(8,10);
         var hour = timestamp.substring(11,13);
         var minute = timestamp.substring(14,16);
         
         var divOutgoing = document.createElement("div");
         divOutgoing.className = "outgoing_msg";
         var divSent = document.createElement("div");
         divSent.className = "sent_msg";
         divOutgoing.appendChild(divSent);
         var content = document.createElement("p");
         content.innerHTML = mcontent;
         divSent.appendChild(content);
         var timedate = document.createElement("span");
         timedate.className = "time_date_out";
         //timedate.innerHTML = hour +":"+ minute + "   |   " + month + " " + day + " " + year;
         timedate.innerHTML = hour +":"+ minute;
         divSent.appendChild(timedate);
         
         document.getElementById("chatHistory").appendChild(divOutgoing);
      },
      createIncomingMessage(){
         var userid = this.userid;
         var mcontent = this.content;
         var timestamp = this.timestamp;
         var year = timestamp.substring(0,4);
         var month = timestamp.substring(5,7);
         var day = timestamp.substring(8,10);
         var hour = timestamp.substring(11,13);
         var minute = timestamp.substring(14,16);
         
         var divIncoming = document.createElement("div");
         divIncoming.className = "incoming_msg";
         var divReceived = document.createElement("div");
         divReceived.className = "received_msg";
         divIncoming.appendChild(divReceived);
         var divReceivedContent = document.createElement("div");
         divReceivedContent.className = "received_withd_msg";
         divReceived.appendChild(divReceivedContent);
         var content = document.createElement("p");
         content.innerHTML = mcontent;
         divReceivedContent.appendChild(content);
         var timedate = document.createElement("span");
         timedate.className = "time_date_in";
         //timedate.innerHTML = hour +":"+ minute + "   |   " + month + " " + day + " " + year;
         timedate.innerHTML = hour +":"+ minute
         divReceivedContent.appendChild(timedate);
         
         document.getElementById("chatHistory").appendChild(divIncoming);
      },
   }

   // SAVE MESSAGE
   function sendMessage(){
      var messageContent = chatInput.value;
      
      $.ajax(
      {
         url: "{% url 'sendMessage' %}",
         type: "GET",
         data:{
            scId: scId,
            messageContent: messageContent,
            classname: classname,
         },
         success: function (response){
            //alert("SUCCESS\n" + response);
            
            scSocket.send(JSON.stringify({
               'todoType': "messageSent",
               'messageId': response,
            }));
            
            chatInput.value = "";
         },
         error: function (response){
            //alert("ERROR!!\n" + response);
         }
      });
   }

   // MENTION OBJECT
   const Mention = {
      id: 0,
      seltxt: '',
      anchorNodeID: 0,
      anchorOffset: 0,
      focusNodeID: 0,
      focusOffset: 0,
      text: '',
      timestamp: "",
      posX: 0,
      posY: 0,
      showMention() {
         var id = this.id;
         var mention = this;
         var manchorNodeID = this.anchorNodeID;
         var mfocusNodeID = this.focusNodeID;
         var mseltxt = this.seltxt;
         var manchorOffset = this.anchorOffset;
         var mfocusOffset = this.focusOffset;
         var mtext = this.text;
         var mposX = this.posX;
         var mposY = this.posY;
         
         var mentionForm = document.createElement("div");
         mentionForm.className = "mentionForm";
         mentionForm.id = `mention${this.id}`;
         mentionForm.setAttribute("data-anchorNodeID", manchorNodeID);
         mentionForm.setAttribute("data-focusNodeID", mfocusNodeID);
         mentionForm.setAttribute("data-anchorOffset", manchorOffset);
         mentionForm.setAttribute("data-focusOffset", mfocusOffset);
         mentionForm.setAttribute("data-seltxt", mseltxt);
         mentionForm.setAttribute("data-posX", mposX);
         mentionForm.setAttribute("data-posY", mposY);
         var mentionContent = document.createElement("textarea");
         mentionContent.className = "mentionContent";
         mentionContent.setAttribute("type", "text");
         mentionContent.setAttribute("id", `mention${this.id}Content`);
         mentionForm.appendChild(mentionContent);
         var mentionCancelBtn = document.createElement("input");
         mentionCancelBtn.className = "mentionCancelBtn";
         mentionCancelBtn.setAttribute("id", `mention${this.id}CancelBtn`);
         mentionCancelBtn.type = "button";
         mentionCancelBtn.addEventListener('click', function(event){
            event.preventDefault();
            
            var start = document.getElementById(manchorNodeID);
            var end = document.getElementById(mfocusNodeID);
            window.getSelection().setBaseAndExtent(start, 0, end, 1);
            document.designMode = "on";
            document.execCommand("RemoveFormat", false, null);
            document.designMode = "off";
            window.getSelection().removeAllRanges();
            
            document.getElementById(mentionForm.id).remove();
         });
         mentionCancelBtn.setAttribute("value", "Cancel");
         mentionForm.appendChild(mentionCancelBtn);
         var mentionSendBtn = document.createElement("input");
         mentionSendBtn.className = "mentionSendBtn";
         mentionSendBtn.setAttribute("id", `mention${this.id}SendBtn`);
         mentionSendBtn.type = "button";
         mentionSendBtn.addEventListener('click', function(event){
            event.preventDefault();
            mtext = document.getElementById(mentionContent.id).value;
            saveMention(mseltxt, mtext, manchorNodeID, manchorOffset, mfocusNodeID, mfocusOffset);
         });
         mentionSendBtn.setAttribute("value", "Send");
         mentionForm.appendChild(mentionSendBtn);
         
         return mentionForm;
      }, incomingMention() {
         var id = this.id;
         var seltxt = this.seltxt;
         var text = this.text;
         var manchorOffset = this.anchorOffset;
         var mfocusOffset = this.focusOffset;
         var timestamp = this.timestamp;
         var year = timestamp.substring(0,4);
         var month = timestamp.substring(5,7);
         var day = timestamp.substring(8,10);
         var hour = timestamp.substring(11,13);
         var minute = timestamp.substring(14,16);
         var mention = this;
         
         var divIncomingMention = document.createElement("div");
         divIncomingMention.id = `mention${this.id}`;
         divIncomingMention.className = "incoming_mention";
         var divReceivedMention = document.createElement("div");
         divReceivedMention.className = "received_width_mention";
         divIncomingMention.appendChild(divReceivedMention);
         var divMentionBox = document.createElement("div");
         divMentionBox.className = "incoming_mention_box";
         divReceivedMention.appendChild(divMentionBox);
         var indexInfo = document.createElement("p");
         indexInfo.className = "incoming_mention_index_info";
         indexInfo.innerHTML = "L" + document.getElementById(this.anchorNodeID).getAttribute('data-lineNumber') + ":" + manchorOffset + " - " + "L" + document.getElementById(this.focusNodeID).getAttribute('data-lineNumber') + ":" + mfocusOffset;
         divMentionBox.appendChild(indexInfo);
         var mentionCode = document.createElement("p");
         mentionCode.className = "incoming_mention_code";
         mentionCode.innerHTML = hljs.highlightAuto(seltxt).value;
         divMentionBox.appendChild(mentionCode);
         var mentionText = document.createElement("p");
         mentionText.className = "incoming_mention_text";
         mentionText.innerHTML = text;
         divMentionBox.appendChild(mentionText);
         var timestamp = document.createElement("span");
         timestamp.className = "time_date_in";
         //timestamp.innerHTML = hour +":"+ minute + "   |   " + month + " " + day + " " + year;
         timestamp.innerHTML = hour +":"+ minute;
         divReceivedMention.appendChild(timestamp);
         
         document.getElementById("chatHistory").appendChild(divIncomingMention);
      }, outgoingMention() {
         var id = this.id;
         var seltxt = this.seltxt;
         var text = this.text;
         var manchorOffset = this.anchorOffset;
         var mfocusOffset = this.focusOffset;
         var timestamp = this.timestamp;
         var year = timestamp.substring(0,4);
         var month = timestamp.substring(5,7);
         var day = timestamp.substring(8,10);
         var hour = timestamp.substring(11,13);
         var minute = timestamp.substring(14,16);
         var mention = this;
         
         var divOutgoingMention = document.createElement("div");
         divOutgoingMention.id = `mention${this.id}`;
         divOutgoingMention.className = "outgoing_mention";
         var divSentMention = document.createElement("div");
         divSentMention.className = "sent_mention";
         divOutgoingMention.appendChild(divSentMention);
         var divMentionBox = document.createElement("div");
         divMentionBox.className = "outgoing_mention_box";
         divSentMention.appendChild(divMentionBox);
         var indexInfo = document.createElement("p");
         indexInfo.className = "outgoing_mention_index_info";
         indexInfo.innerHTML = "L" + document.getElementById(this.anchorNodeID).getAttribute('data-lineNumber') + ":" + manchorOffset + " - " + "L" + document.getElementById(this.focusNodeID).getAttribute('data-lineNumber') + ":" + mfocusOffset;
         divMentionBox.appendChild(indexInfo);
         var mentionCode = document.createElement("p");
         mentionCode.className = "outgoing_mention_code";
         mentionCode.innerHTML = hljs.highlightAuto(seltxt).value;
         divMentionBox.appendChild(mentionCode);
         var mentionText = document.createElement("p");
         mentionText.className = "outgoing_mention_text";
         mentionText.innerHTML = text;
         divMentionBox.appendChild(mentionText);
         var timestamp = document.createElement("span");
         timestamp.className = "time_date_out";
         //timestamp.innerHTML = hour +":"+ minute + "   |   " + month + " " + day + " " + year;
         timestamp.innerHTML = hour +":"+ minute;
         divSentMention.appendChild(timestamp);
         
         document.getElementById("chatHistory").appendChild(divOutgoingMention);
      }
   }

   // CREATE MENTION
   function createMention() {
      if (lastMentionId != 0 && document.getElementById(`mention${lastMentionId}`) != null){
         var last = document.getElementById(`mention${lastMentionId}`);
         
         var start = document.getElementById(last.getAttribute("data-anchorNodeID"));
         var end = document.getElementById(last.getAttribute("data-focusNodeID"));
         window.getSelection().setBaseAndExtent(start, 0, end, 1);
         document.designMode = "on";
         document.execCommand("RemoveFormat", false, null);
         document.designMode = "off";
         window.getSelection().removeAllRanges();
         
         last.remove();
      }
      
      creatingMention = true;
   
      var newMention = Object.create(Mention);
      newMention.id = id;
      id = id;
      lastMentionId = id;
      newMention.seltxt = seltxt.toString();
      newMention.anchorNodeID = anchorNode.parentNode.id;
      newMention.anchorOffset = anchorOffset;
      newMention.focusNodeID = focusNode.parentNode.id;
      newMention.focusOffset = focusOffset;
      newMention.posX = x;
      newMention.posY = y;
      
      var showNewMention = newMention.showMention();
      document.getElementById("code").prepend(showNewMention);
      $(`#${showNewMention.id}`).css({"position": "absolute", "left":`${newMention.posX}px`, "top": `${newMention.posY}px` });
      
      var start = document.getElementById(newMention.anchorNodeID);
      var end = document.getElementById(newMention.focusNodeID);
      window.getSelection().setBaseAndExtent(start, 0, end, 1);
      document.designMode = "on";
      document.execCommand("HiliteColor", false, "#fffead");
      document.designMode = "off";
      window.getSelection().removeAllRanges();
      
      mseltxt = newMention.seltxt;
      manchorNodeID = newMention.anchorNodeID;
      mfocusNodeID = newMention.focusNodeID;
   }

   // SAVE MENTION
   function saveMention(seltxt, text, anchorNodeID, anchorOffset, focusNodeID, focusOffset) {
      $.ajax(
      {
         url: "{% url 'saveMention' %}",
         type: "GET",
         data:{
             scId: {{sc.id}},
             seltxt: seltxt,
             anchorNodeID: anchorNodeID,
             anchorOffset: anchorOffset,
             focusNodeID: focusNodeID,
             focusOffset: focusOffset,
             text: text,
         },
         success: function (response){
            var last = document.getElementById(`mention${lastMentionId}`);
            
            var start = document.getElementById(last.getAttribute("data-anchorNodeID"));
            var end = document.getElementById(last.getAttribute("data-focusNodeID"));
            window.getSelection().setBaseAndExtent(start, 0, end, 1);
            document.designMode = "on";
            document.execCommand("RemoveFormat", false, null);
            document.designMode = "off";
            window.getSelection().removeAllRanges();
            
            last.remove();
            
            creatingMention = false;
            //alert("SUCCESS\n" + response);
            
            scSocket.send(JSON.stringify({
               'todoType': "mentionCreated",
               'mId': response,
            }));
            
            chatInput.value = "";
         },
         error: function (response){
            //alert("ERROR!!\n" + response);
         }
      });
   }

   // NOTIFCATIONS
   function showNotification(text, type){
      if (document.getElementById("notifications") != null){
         document.getElementById("notifications").remove();
      }
      
      var notification = document.createElement("p");
      notification.id = "notifications";
      notification.className = type;
      notification.innerHTML = text;
      document.getElementById("codeMenu").prepend(notification);
      setTimeout(function() {
         $("#notifications").fadeOut(3000);
      }, 5000);
   }

   // CHOOSE
   function choose(text, yes, no){
      if (document.getElementById("choose") != null){
         document.getElementById("choose").remove();
      }
      
      var choose = document.createElement("div");
      choose.id = "choose";
      var chooseText = document.createElement("p");
      chooseText.className = "chooseText";
      chooseText.innerHTML = text;
      choose.appendChild(chooseText);
      var chooseYes = document.createElement("input");
      chooseYes.id = "chooseYes";
      chooseYes.type = "button";
      chooseYes.className = "chooseBtn";
      chooseYes.value = "Yes";
      chooseYes.addEventListener('click', yes);
      choose.appendChild(chooseYes);
      var chooseNo = document.createElement("input");
      chooseNo.id = "chooseNo";
      chooseNo.type = "button";
      chooseNo.className = "chooseBtn";
      chooseNo.value = "No";
      chooseNo.addEventListener('click', no);
      choose.appendChild(chooseNo);
      
      document.getElementById("codeMenu").prepend(choose);
   }
   
   // ALLOW SPEAKER
   function acceptSpeakerRequest(fromU, toU) {
      document.getElementById("choose").remove();
      scSocket.send(JSON.stringify({
         'todoType': "speakerRequestResponse",
         'speakerU': toU,
         'requestU': fromU,
         'response': true,
      }));
      
      document.getElementById("speaker").checked = false;
      choose("Do you want to turn on\nthe auto focus function?",
      function(){
         document.getElementById("auto-focus-value").checked = true;
         document.getElementById("choose").remove();
      }, function(){
         document.getElementById("auto-focus-value").checked = false;
         document.getElementById("choose").remove();
      });
   }

   // DECLINE SPEAKER
   function declineSpeakerRequest(fromU, toU) {
      document.getElementById("choose").remove();
      scSocket.send(JSON.stringify({
         'todoType': "speakerRequestResponse",
         'ownerU': toU,
         'requestU': fromU,
         'response': false,
      }));
   }

   var folderNode = document.getElementById("dirTree");

     const folderSocket = new WebSocket('ws://' + window.location.host + "/ws/folder/" + "{{user}}" + '/');

     folderSocket.onmessage = function(e){
        var data = JSON.parse(e.data);
        
        var folder = document.createElement("div");
        folder.className = "folder";
        var icon = document.createElement("i");
        icon.className = "fas fa-folder folderIcon";
        folder.appendChild(icon);
        var a = document.createElement("a");
        a.innerHTML = data['folderName'];
        folder.appendChild(a);
        document.getElementById("dirTree").appendChild(folder);
     };

     folderSocket.onclose = function(e){
        //alert("SOCKET CLOSED");
     };

     //ADD FOLDER
     function addFolderText(){

        if (document.getElementById("addfolder") != null){
           document.getElementById("addfolder").remove();
        }
        
        var addfolder = document.createElement("div");
        addfolder.id = "addfolder";
        var folderInput = document.createElement("input");
        folderInput.id = "folder_name";
        folderInput.type = "text";
        addfolder.appendChild(folderInput);
        var folderButton = document.createElement("button");
        folderButton.id = "btnFolderCreate";
        folderButton.addEventListener('click', function(event){
           addFolder();
        });
        folderButton.innerHTML = "+";
        addfolder.appendChild(folderButton);
        document.getElementById("dirTree").appendChild(addfolder);
        //folderNode.innerHTML += "<input id='folder_name' type='text' ><button id='btnFolderCreate' onclick='addFolder()'>+<br>";
     }
     function addFolder(){
        $.ajax({
           url: "{% url 'addFolder' %}",
           type: "GET",
           data:{
              classname: "{{className}}",
              foldername: $("#folder_name").val()
           },
           success: function (response){
              //alert("SUCCESS\n" + response);
              document.getElementById("addfolder").remove();

              folderSocket.send(JSON.stringify({
                 'classId': "{{class.id}}",
                 'folderId': response,
              }));

           },
           error: function (response){
              alert("ERROR\n" + response);
           }

        });

     }
   
   
</script>


{% endblock %}
